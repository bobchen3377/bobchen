---
layout: post
title: Nginx + Vsftpd Construct Static Resource Server
date: 2017-01-10
category: Nginx
---

### 序言

对于网站的静态资源，例如图片，如果直接放在项目里面，在分布式部署下会出现诸如难以同步等问题。  
所以，网站静态资源往往放在一个独立的静态资源服务器上。  
本文主要介绍如何使用nginx作为http服务器以及vsftp作为FTP服务器，在linux上搭建一个图片服务器。    
OS: CentOS 6.4, 32bits. VM虚拟机   
Nginx: nginx-1.8.0.tar.gz or nginx-1.8.1.tar.gz (现在最新的stable version是nginx-1.10.3)

### 1. Install and configure nginx   

#### **1.1) Download Nginx**

在官网Download：<a href="http://www.nginx.org/" target="_blank">www.nginx.org</a>

用**SecureCRT**的**SFTP**功能把 *nginx-1.8.0.tar.gz* 上传到linux虚拟机上。

#### **1.2) Install Nginx**

为了使安装顺利，要先安装以下Package:  
* gcc 安装nginx需要先将官网下载的源码进行编译，编译依赖gcc环境

* pcre 一个Perl库，包括 perl 兼容的正则表达式库。nginx的http模块使用pcre来解析正则表达式。pcre-devel是使用pcre开发的一个二次开发库。nginx也需要此库。 

* zlib zlib库提供了很多种压缩和解压缩的方式，nginx使用zlib对http包的内容进行gzip。

* openssl 是一个强大的安全套接字层密码库，囊括主要的密码算法、常用的密钥和证书封装管理功能及SSL协议，并提供丰富的应用程序供测试或其它目的使用。nginx不仅支持http协议，还支持https（即在ssl协议上传输http）。

Cammand: `yum -y install gcc-c++ pcre pcre-devel zlib zlib-devel openssl openssl-devel`

然后解压：`tar -zxvf nginx-1.8.0.tar.gz`  
得到 *nginx-1.8.0*
```
[root@bob SFTP]# ll
total 820
drwxr-xr-x. 9 1001 1001   4096 Jan  9 17:01 nginx-1.8.0
-rw-r--r--. 1 root root 832104 Nov  1 01:10 nginx-1.8.0.tar.gz
```

执行以下命令进行makefile设置
```
cd nginx-1.8.0

./configure \
--prefix=/usr/local/nginx \
--pid-path=/var/run/nginx/nginx.pid \
--lock-path=/var/lock/nginx.lock \
--error-log-path=/var/log/nginx/error.log \
--http-log-path=/var/log/nginx/access.log \
--with-http_gzip_static_module \
--http-client-body-temp-path=/var/temp/nginx/client \
--http-proxy-temp-path=/var/temp/nginx/proxy \
--http-fastcgi-temp-path=/var/temp/nginx/fastcgi \
--http-uwsgi-temp-path=/var/temp/nginx/uwsgi \
--http-scgi-temp-path=/var/temp/nginx/scgi
```
* 注意上面的/var/temp/nginx目录需要在执行命令前手动创建 `mkdir /var/temp/nginx -p`
* 执行成功后， 在目录下将会增加了 *Makefile* 文件

然后编译安装：
```
make
make install
```

安装成功后文件目录如下：
```
[root@bob ~]# cd /usr/local/nginx/
[root@bob nginx]# ll
total 12
drwxr-xr-x. 2 root root 4096 Mar 11 06:33 conf
drwxr-xr-x. 2 root root 4096 Jan  9 19:57 html
drwxr-xr-x. 2 root root 4096 Jan  9 19:57 sbin
```

启动nginx：
```
cd /usr/local/nginx/sbin/
./nginx 
```
* 注意：执行./nginx启动nginx，这里可以-c指定加载的nginx配置文件，如下：
./nginx -c /usr/local/nginx/conf/nginx.conf
如果不指定-c，nginx在启动时默认加载conf/nginx.conf文件，  
此文件的地址也可以在编译安装nginx时指定./configure的参数（--conf-path= 指向配置文件（nginx.conf））

查看nginx进程：
```
[root@bob nginx]# ps aux|grep nginx
root      2558  0.0  0.1   5332   564 ?        Ss   Mar21   0:00 nginx: master process ./nginx
nobody    2559  0.0  0.2   5532  1076 ?        S    Mar21   0:00 nginx: worker process
root     16186  0.0  0.1   4360   712 pts/0    S+   09:42   0:00 grep nginx
```

另外还有以下常用命令：
* 完整停止：`./nginx -s quit` （建议使用）
* 快速停止：`./nginx -s stop`
* 重启（重新加载配置文件）：`./nginx -s reload`

最后关闭linux防火墙：
```
[root@bob ~]# service iptables stop
iptables: Flushing firewall rules:                         [  OK  ]
iptables: Setting chains to policy ACCEPT: filter          [  OK  ]
iptables: Unloading modules:                               [  OK  ]
```
如果不想关闭防火墙，可以修改防火墙配置文件，开放80端口：  
在 `/etc/sysconfig/iptables` 加入  
`-A INPUT -p tcp -m state --state NEW -m tcp --dport 80 -j ACCEPT`
```
[root@bob nginx]# vim /etc/sysconfig/iptables
# Generated by iptables-save v1.4.7
*filter
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [4:448]
-A INPUT -p tcp -m tcp --dport 8080 -j ACCEPT
-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
-A INPUT -p icmp -j ACCEPT
-A INPUT -i lo -j ACCEPT
-A INPUT -p tcp -m state --state NEW -m tcp --dport 22 -j ACCEPT
#Add below line
-A INPUT -p tcp -m state --state NEW -m tcp --dport 80 -j ACCEPT
-A INPUT -j REJECT --reject-with icmp-host-prohibited
-A FORWARD -j REJECT --reject-with icmp-host-prohibited
COMMIT
# Completed
```

修改并保存后重启防火墙：
```
[root@bob nginx]# service iptables restart
iptables: Flushing firewall rules:                         [  OK  ]
iptables: Setting chains to policy ACCEPT: filter          [  OK  ]
iptables: Unloading modules:                               [  OK  ]
iptables: Applying firewall rules:                         [  OK  ]
```

访问nginx服务：
<img src="\assets\images\nginx-vsftpd-staticResourceServer/nginx-vsftpd-staticResourceServer-1.png" width="800" />

**Nginx**安装配置成功！

---

### 2. Install and configure vsftpd

#### **2.1) Use yum to install vsftpd**
Cammand: `[root@bob ~]# yum -y install vsftpd`

#### **2.2) Configure vsftpd**
创建一个ftp服务器用户：`[root@bob ~]# useradd ftpuser`  
添加ftp用户密码：`[root@bob ~]# passwd ftpuser`

用浏览器使用ftp协议访问时应该是被动模式，所以需要设置被动模式的端口：  
在 `/etc/vsftpd/vsftpd.conf` 加入   
`pasv_min_port=30000`  
`pasv_max_port=30999`
```
[root@bob ~]# vim /etc/vsftpd/vsftpd.conf

pam_service_name=vsftpd
userlist_enable=YES
tcp_wrappers=YES
#Add below two lines
pasv_min_port=30000
pasv_max_port=30999
```
修改后重启vsftpd服务：`service vsftpd restart`  
* 其他命令：开启服务 -> `service vsftpd start`，停止服务 -> `service vsftpd stop`

因为ftp默认的主动模式端口为21，所以要开启防火墙21端口以及被动模式的30000~30999端口：  
在 `/etc/sysconfig/iptables` 加入  
`-A INPUT -p tcp -m state --state NEW -m tcp --dport 21 -j ACCEPT`  
`-A INPUT -p tcp -m state --state NEW -m tcp --dport 30000:30999 -j ACCEPT`

```
[root@bob ~]# vim /etc/sysconfig/iptables
# Generated by iptables-save v1.4.7
*filter
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [4:448]
-A INPUT -p tcp -m tcp --dport 8080 -j ACCEPT
-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
-A INPUT -p icmp -j ACCEPT
-A INPUT -i lo -j ACCEPT
-A INPUT -p tcp -m state --state NEW -m tcp --dport 22 -j ACCEPT
-A INPUT -p tcp -m state --state NEW -m tcp --dport 80 -j ACCEPT
#Add below two lines
-A INPUT -p tcp -m state --state NEW -m tcp --dport 21 -j ACCEPT
-A INPUT -p tcp -m state --state NEW -m tcp --dport 30000:30999 -j ACCEPT
-A INPUT -j REJECT --reject-with icmp-host-prohibited
-A FORWARD -j REJECT --reject-with icmp-host-prohibited
COMMIT
# Completed
```

然后重启防火墙：
```
[root@bob nginx]# service iptables restart
iptables: Flushing firewall rules:                         [  OK  ]
iptables: Setting chains to policy ACCEPT: filter          [  OK  ]
iptables: Unloading modules:                               [  OK  ]
iptables: Applying firewall rules:                         [  OK  ]
```

访问ftp服务：
vsftpd的默认根目录是 `/var/ftp/`
```
[root@bob ~]# cd /var/ftp/
[root@bob ftp]# ll
total 4
drwxr-xr-x. 2 root root 4096 May 11  2016 pub
```
<img src="\assets\images\nginx-vsftpd-staticResourceServer/nginx-vsftpd-staticResourceServer-2.png" width="800" />

**Vsftpd**安装配置成功！

---

### 3. Integrate Nginx and Vsftpd
用vsftpd构建好的ftp服务器只能通过ftp协议进行访问。但是未来为了让其他服务能够访问ftp图片服务器，例如上传图片， 就需要通过http进行访问。 那么可以让nginx的根目录指向ftp上传文件的目录。

